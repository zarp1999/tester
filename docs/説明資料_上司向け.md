# TESTERアプリケーション 説明資料

## 1. アプリケーション概要

**TESTER**は、CityJSON形式の3D都市データを可視化し、管路（パイプライン）の断面表示と距離計測を行うWebアプリケーションです。

### 目的
- 管路データの3D可視化による空間把握の向上
- 断面図生成による管路の深さ・配置の詳細確認
- 管路間の距離計測による設計検証の支援

### 特徴
- **3Dリアルタイム描画**: Three.jsによる高品質な3Dレンダリング
- **インタラクティブ操作**: マウス・キーボードによる直感的な操作
- **断面図自動生成**: クリックした位置を基準に断面図を自動生成
- **距離計測機能**: 管路間の最近接距離と指定点間距離の同時表示

---

## 2. 主要機能

### 2.1 3Dシーン表示機能
**コンポーネント**: `Scene3D.js` (約1,800行)

- CityJSONデータから管路オブジェクトを自動生成
- 材質・種別に応じた色分け表示（設定ファイルベース）
- カメラ操作
  - マウス: 右ドラッグで回転、中クリックでズーム
  - キーボード: W/A/S/D/Q/E で移動、Shiftで低速モード
- ガイド表示: 画面左上に操作方法、左下にカメラ位置情報
- 管路情報表示: クリックした管路の属性情報を表示・編集

### 2.2 断面図生成機能
**コンポーネント**: `CrossSectionPlane.js` (約530行)

- **断面平面の定義**: クリックした管路のZ座標を断面平面として採用
- **縦線表示**: 断面平面と交差するすべての管路に縦線（床→管路上端）を描画
- **深さラベル**: 各管路の深さを数値で表示（カメラ距離に応じてスケール調整）
- **断面形状表示**: CSG（Constructive Solid Geometry）を使用して管路の切り口を3Dメッシュとして生成
- **グリッド表示**: 1m間隔の水平グリッド線で深度感を表現

### 2.3 距離計測機能
**コンポーネント**: `DistanceMeasurement.js` (約1,085行)

- **指定距離計測**: 左Shift + 左ドラッグで2つの管路を選択し、クリック位置間の距離を計測
- **最近接距離計測**: 2つの管路（またはCSG断面）の最短距離を自動計算
  - 頂点・辺・面すべてを考慮した高精度な計算
- **可視化**: 計測線（赤: 指定距離、青: 最近接距離）と数値ラベルを表示
- **表示切替**: 5キーで指定/最近接の表示を切り替え、Escでクリア

---

## 3. 技術スタック

### フロントエンド
- **React 18.2.0**: UIフレームワーク
- **Three.js 0.157.0**: 3Dグラフィックスライブラリ
- **three-csg-ts 3.2.0**: CSG（立体の交差計算）ライブラリ
- **React Router 7.9.4**: ルーティング（3Dビュー / 断面ビューの切り替え）

### 開発ツール
- **react-scripts 5.0.1**: Create React Appベースの開発環境
- **npm**: パッケージ管理

### データ形式
- **CityJSON**: 3D都市データの標準フォーマット（ISO 19152-2）
- **JSON設定ファイル**: 色定義、形状タイプ、ソースタイプ等

---

## 4. アーキテクチャ概要

### 4.1 全体構成

```
src/
├── index.js                    # エントリーポイント
├── ViewerApp.js                # メインレイアウト（左: 3D表示、右: レイヤーパネル/地図）
├── App.js                      # ルーティング & データローダー
└── components/
    ├── Scene3D.js              # 3Dシーン本体（約1,800行）
    ├── CrossSectionPlane.js    # 断面描画ロジック（約530行）
    ├── DistanceMeasurement.js  # 距離計測ロジック（約1,085行）
    ├── PipelineInfoDisplay.js  # 管路情報UI
    ├── PipelineActionButtons.js # 管路操作ボタン
    └── views/
        ├── Scene3DView.js       # 3Dシーンビューラッパー
        └── CrossSectionView.js  # 断面ビューラッパー
```

### 4.2 データフロー

```
1. アプリ起動
   ↓
2. App.js が JSON ファイルを読み込み
   ├─ Cityjson_sample.json  (管路データ)
   ├─ layer_panel.json      (色・透明度定義)
   ├─ shape_type.json       (形状タイプ)
   ├─ source_types.json     (ソースタイプ)
   └─ user_pos_1.json       (初期カメラ位置)
   ↓
3. Scene3D.js がデータを受け取り、Three.js メッシュを生成
   ↓
4. ユーザー操作
   ├─ 管路クリック → PipelineInfoDisplay に情報表示
   ├─ 断面モードでクリック → CrossSectionPlane が断面生成
   └─ Shift+ドラッグ → DistanceMeasurement が距離計測
```

### 4.3 主要コンポーネントの責務

#### Scene3D.js
- Three.js シーン・カメラ・レンダラーの管理
- CityJSONから3Dメッシュ生成
- マウス/キーボードイベント処理
- 管路の選択・ドラッグ・複製・削除機能
- 断面図モードと通常モードの切り替え

#### CrossSectionPlane.js
- 断面平面（Z座標固定）の定義
- 断面平面と交差する管路の検出
- 縦線・グリッド線・ラベルの描画
- CSGによる断面形状の生成
- 断面情報の一括描画（重複除去）

#### DistanceMeasurement.js
- 左Shift + ドラッグの検出
- 管路間の距離計算（指定距離 / 最近接距離）
- 計測線・ラベルの描画とカメラ追従
- 表示切替・クリア機能

---

## 5. 主要機能の技術的詳細

### 5.1 断面図生成の仕組み

1. **断面平面の決定**
   - ユーザーが管路をクリック
   - クリック位置のZ座標を断面平面として設定

2. **交差する管路の検出**
   ```javascript
   // すべての管路について
   - 管路の中心軸と断面平面（Z=固定値）の交点を計算
   - 交差判定（管路のZ範囲内かチェック）
   - 交差する場合、縦線を描画
   ```

3. **断面形状の生成**
   ```javascript
   // CSG（Constructive Solid Geometry）を使用
   - 管路メッシュと薄いボックス（断面平面）を作成
   - CSG.intersect() で交差部分を計算
   - 交差部分のみを3Dメッシュとして表示
   ```

### 5.2 距離計測の仕組み

1. **指定距離**
   - レイキャスターでクリック位置の3D座標を取得
   - 2点間のユークリッド距離を計算

2. **最近接距離**
   - 2つの管路メッシュの全頂点・辺・面を取得
   - 点-面、辺-辺、頂点-面の組み合わせで最短距離を探索
   - 計算量: O(n×m) （n, mは各メッシュの要素数）

### 5.3 パフォーマンス最適化

- **断面描画の最適化**: 重複を除去して一括描画
- **ラベルスケール調整**: カメラ距離に応じて動的に調整
- **マウス移動の最適化**: フラグ管理で不要なレイキャスティングを抑制
- **リソース管理**: オブジェクト削除時にジオメトリ・マテリアルを適切に破棄

---

## 6. データ構造

### 6.1 CityJSONデータ構造
```json
{
  "CityObjects": {
    "pipe_001": {
      "type": "Pipe",
      "geometry": [{
        "type": "LineString",
        "vertices": [[x1, y1, z1], [x2, y2, z2], ...]
      }],
      "attributes": {
        "radius": 0.3,
        "material": "concrete",
        "pipe_kind": "water",
        "start_point_depth": 150,
        "end_point_depth": 200
      }
    }
  }
}
```

### 6.2 座標系
- **CityJSON**: [東西(X), 南北(Z), 上下(Y)]
- **Three.js**: (x, y, z) = (東西, 上下, 南北)
- **変換処理**: Scene3D.js内で適切に変換

---

## 7. 使用方法

### 7.1 基本操作

| 操作 | 説明 |
|------|------|
| 右ドラッグ | カメラ回転 |
| 中クリック | ズーム |
| W/A/S/D/Q/E | カメラ移動（Shiftで低速） |
| 左クリック | 管路選択（通常モード）または断面生成（断面モード） |
| Shift+左ドラッグ | 距離計測開始 |
| ESC | 選択解除 / 計測クリア |
| 1 | ガイド表示切替 |
| 7 | 管路表示切替（断面モード時は切り口も連動） |

### 7.2 断面図モードの使い方

1. `/cross-section` ルートにアクセス
2. 任意の管路をクリック
3. クリック位置のZ座標を基準に断面図が自動生成
   - 水平グリッド線（1m間隔）
   - 交差する管路の縦線と深さラベル
   - 管路の切り口（7キーで表示/非表示）

---

## 8. ソースコードの品質

### 8.1 コード整理済み項目
- ✅ 不要なコメントの削除
- ✅ 重複コードの共通化（半径取得、座標計算）
- ✅ 未使用変数の削除
- ✅ デバッグ用console.logの削除
- ✅ 関数の責務分離と単一責任の原則

### 8.2 コーディングスタイル
- JSDocコメントで主要関数を説明
- 一貫した命名規則
- エラーハンドリングの実装
- リソースの適切なクリーンアップ

---

## 9. 今後の拡張可能性

### 9.1 機能拡張の余地
- **エクスポート機能**: 断面図の画像/PDF出力
- **アニメーション**: 断面平面の移動アニメーション
- **複数断面の同時表示**: 複数の断面図を並べて表示
- **計測結果の保存**: 計測データのJSON/CSVエクスポート
- **管路の編集機能**: 位置・深さ・属性の一括編集

### 9.2 パフォーマンス改善
- WebWorkerを使用した距離計算の並列化
- LOD（Level of Detail）による遠方オブジェクトの簡略化
- データのインクリメンタルロード

### 9.3 UI/UX改善
- ツールバーの追加（操作ボタンの視覚化）
- ショートカットキーのヘルプ表示
- 設定パネル（カメラ速度、グリッド間隔等の調整）

---

## 10. 技術的な特徴・工夫点

### 10.1 CSGによる高精度な断面表示
従来の円形断面表示ではなく、実際の管路形状をCSGで切断した正確な断面を表示。これにより、実際の施工状況により近い視覚化が可能。

### 10.2 重複除去による効率化
断面情報を一時配列に収集し、最後に一括描画することで重複を除去。同じ管路の断面が複数回描画されることを防止。

### 10.3 カメラ距離に応じた動的スケール調整
深さラベルと計測ラベルのスケールをカメラ距離に応じて動的に調整。近づいても遠ざかっても常に読みやすいサイズを維持。

---

## 11. まとめ

TESTERアプリケーションは、以下の価値を提供します：

1. **直感的な3D可視化**: 複雑な管路データを視覚的に理解
2. **正確な断面表示**: CSG技術による高精度な断面図生成
3. **実用的な計測機能**: 設計検証に必要な距離情報を提供
4. **拡張性**: モジュール設計により、機能追加が容易

本アプリケーションは、管路設計・施工管理における可視化ツールとして活用可能です。

